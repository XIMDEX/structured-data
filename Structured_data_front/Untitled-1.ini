// ===================================================================
// MAIN FUNCTION: LOAD SCHEMA (GET /schema)
// ===================================================================
async function loadSchema() {
Â  Â  messageArea.textContent = 'Cargando...';
Â  Â  messageArea.className = '';
Â  Â  formContainer.innerHTML = '<h2>Formulario DinÃ¡mico</h2>'; // Clear

Â  Â  const schemaId = schemaIdInput.value;
Â  Â  if (!schemaId) {
Â  Â  Â  Â  messageArea.textContent = 'Por favor, introduce un ID de esquema vÃ¡lido.';
Â  Â  Â  Â  messageArea.className = 'error';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const endpoint = `${API_BASE_URL}/schema/${schemaId}`;

Â  Â  try {
Â  Â  Â  Â  const response = await fetch(endpoint);
Â  Â  Â  Â  
Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  const errorText = response.status === 404 ? 'Esquema no encontrado (Error 404).' : `Error HTTP: ${response.status} ${response.statusText}`;
Â  Â  Â  Â  Â  Â  throw new Error(errorText);
Â  Â  Â  Â  }

Â  Â  Â  Â  const schemaData = await response.json();
Â  Â  Â  Â  
Â  Â  Â  Â  currentSchemaDefinition = schemaData;

Â  Â  Â  Â  messageArea.textContent = `âœ… Esquema ID ${schemaId} (${schemaData.label}) cargado correctamente.`;
Â  Â  Â  Â  messageArea.className = 'success';
Â  Â  Â  Â  
Â  Â  Â  Â  renderForm(schemaData); 

Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error al cargar el esquema:', error);
Â  Â  Â  Â  messageArea.textContent = `âŒ Error: ${error.message}`;
Â  Â  Â  Â  messageArea.className = 'error';
Â  Â  }
}

// ===================================================================
// FUNCTION FOR DYNAMIC FORM GENERATION
// ===================================================================
function renderForm(schema) {
Â  Â  formContainer.innerHTML = '';
Â  Â  const form = document.createElement('form');
Â  Â  form.id = 'dynamic-item-form';
Â  Â  
Â  Â  const title = document.createElement('h2');
Â  Â  title.textContent = `Crear Ãtem: ${schema.label} (ID: ${schema.id})`;
Â  Â  formContainer.appendChild(title);

Â  Â  const schemaIdHidden = document.createElement('input');
Â  Â  schemaIdHidden.type = 'hidden';
Â  Â  schemaIdHidden.name = 'schema_id';
Â  Â  schemaIdHidden.value = schema.id;
Â  Â  form.appendChild(schemaIdHidden);

Â  Â  const properties = schema.properties || {};
Â  Â  
Â  Â  for (const key in properties) {
Â  Â  Â  Â  if (properties.hasOwnProperty(key)) {
Â  Â  Â  Â  Â  Â  const prop = properties[key];
Â  Â  Â  Â  Â  Â  const propGroup = document.createElement('div');
Â  Â  Â  Â  Â  Â  propGroup.className = 'property-group';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const label = document.createElement('label');
Â  Â  Â  Â  Â  Â  label.textContent = `${prop.label}`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (prop.min_cardinality > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  label.textContent += ` * (MÃ­n: ${prop.min_cardinality})`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const typeInfo = prop.types[0]; 
Â  Â  Â  Â  Â  Â  const input = document.createElement('input');

Â  Â  Â  Â  Â  Â  input.dataset.typeId = typeInfo.id; 
Â  Â  Â  Â  Â  Â  input.name = prop.label; 
Â  Â  Â  Â  Â  Â  input.required = prop.min_cardinality > 0; 

Â  Â  Â  Â  Â  Â  if (typeInfo.type === 'Text' || typeInfo.type === 'Boolean') {
Â  Â  Â  Â  Â  Â  Â  Â  input.type = 'text';
Â  Â  Â  Â  Â  Â  } else if (typeInfo.type === 'Number') {
Â  Â  Â  Â  Â  Â  Â  Â  input.type = 'number';
Â  Â  Â  Â  Â  Â  } else if (typeInfo.type === 'Date') {
Â  Â  Â  Â  Â  Â  Â  Â  input.type = 'date';
Â  Â  Â  Â  Â  Â  } else if (typeInfo.type === 'Thing') {
Â  Â  Â  Â  Â  Â  Â  Â  input.type = 'number'; 
Â  Â  Â  Â  Â  Â  Â  Â  input.placeholder = `ID del Ãtem relacionado (${typeInfo.schema_label})`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  input.type = 'text'; 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  propGroup.appendChild(label);
Â  Â  Â  Â  Â  Â  propGroup.appendChild(document.createElement('br'));
Â  Â  Â  Â  Â  Â  propGroup.appendChild(input);

Â  Â  Â  Â  Â  Â  const comment = document.createElement('small');
Â  Â  Â  Â  Â  Â  comment.textContent = prop.comment;
Â  Â  Â  Â  Â  Â  propGroup.appendChild(comment);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  form.appendChild(propGroup);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  const submitBtn = document.createElement('button');
Â  Â  submitBtn.type = 'submit';
Â  Â  submitBtn.textContent = 'ğŸ’¾ Crear Ãtem';
Â  Â  form.appendChild(submitBtn);

Â  Â  formContainer.appendChild(form);
Â  Â  
Â  Â  // Interfaz de Lectura/ActualizaciÃ³n/EliminaciÃ³n
Â  Â  const crudControls = document.createElement('div');
Â  Â  crudControls.id = 'crud-controls';
Â  Â  crudControls.innerHTML = `
Â  Â  Â  Â  <hr>
Â  Â  Â  Â  <h3>Operaciones CRUD (ID 3 Creado)</h3>
Â  Â  Â  Â  <input type="number" id="item-id-input" value="3" min="1" required>
Â  Â  Â  Â  <button id="read-item-btn">ğŸ” Leer Ãtem</button>
Â  Â  Â  Â  <button id="update-item-btn">âœï¸ Actualizar Ãtem</button> 
Â  Â  Â  Â  <button id="delete-item-btn">ğŸ—‘ï¸ Eliminar Ãtem</button>
Â  Â  Â  Â  <div id="item-read-output"></div>
Â  Â  `;
Â  Â  formContainer.appendChild(crudControls);

Â  Â  // Event Listeners for CRUD operations
Â  Â  form.addEventListener('submit', handleFormSubmit);
Â  Â  
Â  Â  document.getElementById('read-item-btn').addEventListener('click', () => {
Â  Â  Â  Â  const itemId = document.getElementById('item-id-input').value;
Â  Â  Â  Â  if (itemId) {
Â  Â  Â  Â  Â  Â  fetchItem(itemId);
Â  Â  Â  Â  }
Â  Â  });

    document.getElementById('update-item-btn').addEventListener('click', () => {
        const itemId = document.getElementById('item-id-input').value;
        
        // Test payload for update: changes the 'name'.
        // Assumes 2802 is the type ID for the 'name' property of schema 132
        const updatePayload = {
            "properties": {
                "name": { 
                    "type": 2802, 
                    "values": ["Villa Actualizada por PATCH"] 
                }
            }
        };

        if (itemId) {
            updateItem(itemId, updatePayload);
        }
    });

    document.getElementById('delete-item-btn').addEventListener('click', () => {
        const itemId = document.getElementById('item-id-input').value;
        
        if (itemId && confirm(`Â¿EstÃ¡s seguro de que quieres ELIMINAR el Ãtem ID ${itemId}? Esta acciÃ³n es irreversible.`)) {
            deleteItem(itemId);
        }
    });
}
